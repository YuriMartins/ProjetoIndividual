<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/styleDashboard.css">
    <link rel="stylesheet" href="./css/styleTransfer.css">
    <title>Transferência</title>
</head>

<body onload="minhaConta()">
    <div class="sideBar" onclick="sideBarFunction()" id="sideBar">
        <div>
            <img src="./assets/iconDefault.svg" class="iconDefaultUser" alt="">
        </div>
        <img class="iconWallet" src="./assets/iconWallet.svg" alt="">
        <img class="iconTrasfer" src="./assets/iconTrasfer.svg" alt="">
        <img class="iconStatement" src="./assets/iconStatement.svg" alt="">
        <div>
            <img class="exitIcon" src="./assets/iconExit.svg" alt="">
            <img class="imgLine" src="./\assets/iconLine.svg" alt="">
            <img class="imgConfig" src="./assets/iconConfig.svg" alt="">
        </div>
    </div>
    <div class="side" id="side">
        <div>
            <div class="row">
                <h4 class="nameSide" id="usuario3"></h4>
                <img class="imgUserSide" src="assets/iconExitSmall.svg" alt="">
            </div>
            <h5 class="emailSide" id="email"></h5>
        </div>
        <a href="dashboard.html">
            <h6 class="walletH6">Minha carteira</h6>
        </a>
        <a href="trasfer.html">
            <h6 class="trasferH6">Transferência</h6>
        </a>
        <a href="statement.html">
            <h6 class="statementH6">Extrato</h6>
        </a>
        <div>
            <h6 class="exitH6">Sair</h6>
            <h6 class="configH6">Configurações</h6>
        </div>
    </div>
    <div class="dashboard">
        <div class="row7">
            <h2 class="h2Title">Transferência</h2>
        </div>

        <form action="" class="formTrasfer">
            <h2 class="h2Title">Informe o cpf do beneficiário:</h2>
            <input type="number" class="inputCpf" id="cpfInput">

            <h2 class="h2Title">Valor de transfêrencia:</h2>
            <input type="number" class="inputTrasfer" id="valorTrasferInput">

            <h2 class="h2Title">Data de transferência:</h2>
            <input type="datetime" class="inputDate">
            <h2 class="h2Title">Descrição:</h2>
            <div class="row10">
                <textarea type="text" class="textAreaTrasfer"></textarea>
                <div class="column1">
                    <button type="button" class="buttonEnviar" onclick="trasfer()">Enviar</button>
                    <button type="reset" class="buttonLimpar">Limpar</button>
                </div>
            </div>
        </form>
    </div>

</body>

</html>


<script>
    var saldoConta = 0
    usuario3.innerHTML = `${sessionStorage.nomeCliente}`;
    email.innerHTML = `${sessionStorage.emailCliente}`;
    var cpfListar = `${sessionStorage.cpfCliente}`;

    function sideBarFunction() {
        side.style.display = `flex`
        sideBar.addEventListener("dblclick", () => {
            side.style.display = `none`
        })
    }

    //      function sideBarFunction2() { outro jeito de fazer double click
    //   side.style.display = `none`
    //      }

    function minhaConta() {
        const idUsuario = sessionStorage.idCliente;

        fetch(`/usuarios/listarConta/${idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then((resposta) => {
            // saldoConta
            resposta.json().then((data) => {
                console.log(data);
                saldoConta = `${data[0].saldoConta}`
                //return data[0].saldoConta
            })


            // if (resposta.ok) {
            //     window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
            //     window.location = "/dashboard/mural.html";
            //     limparFormulario();
            //     finalizarAguardar();
            // } else if (resposta.status == 404) {
            //     window.alert("Deu 404!");
            // } else {
            //     throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            // }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            finalizarAguardar();
        });


    }










    function trasfer() {
        //aguardar();
        cpfVar = cpfInput.value
        valorTrasferVar = valorTrasferInput.value

        if (cpfVar == "") {
            //cardErro.style.display = "block"
            //mensagem_erro.innerHTML = "(Mensagem de erro para todos os campos em branco)";
            //finalizarAguardar();
            return false;
        }
        else {
            //setInterval(sumirMensagem, 5000)
        }

        console.log("FORM cpf: ", cpfVar);

        fetch("/usuarios/autenticarCpf", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                cpfServer: cpfVar,
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO autenticarCpf()!")
            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));
                });
                updateSaldo()



            } else {

                console.log("Houve um erro ao tentar autenticar o cpf!");

                resposta.text().then(texto => {
                    //console.error(texto);
                    // finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function updateSaldo() {

        // const a = minhaConta()
        //console.log(a)
        if (saldoConta >= valorTrasferVar) {
            console.log("saldo maior que valor da Trasferencia!");

            fetch("/usuarios/updateSaldo", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    valorTrasferServer: valorTrasferVar,
                    cpfServer: cpfVar,
                }),
            }).then((response) => {
                response.json().then((data) => {
                    const msg = data.mensagem;

                    console.log(msg);
                    if (msg == "success") {
                        console.log("sucesso ao tentar atualizar o saldo!");
                    } else {
                        console.log("Houve um erro ao tentar atualizar o saldo!");
                    }
                });
            });


        } else {
            console.log("saldo menor que valor da Trasferencia!");
        }
    }














</script>